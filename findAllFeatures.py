# Farokh Confectioner
# Fabio Di Troia
# Finds all of the permissions which appear in the malare and binary datasets

import sys
import os
import traceback

# args[1]: Directory of the malware dataset
# args[2]: Directory of the benign dataset
# args[3]: Output file
def main(args):
  MINIMUM_ARGS = 4
  if len(args) != MINIMUM_ARGS:
    print("Please enter correct number of args")
    exit(1)

  MALWARE_DIR = args[1]
  BENIGN_DIR = args[2]
  OUTPUT = args[3]
  copyPermissions(MALWARE_DIR, OUTPUT)
  copyPermissions(BENIGN_DIR, OUTPUT)

def copyPermissions(permission_dir, out_dir):
  try:
    os.remove(out_dir)
  except Exception:
    print("File: {} does not exist".format(out_dir))
  try:
    XML_TYPE = "xml"
    for root, dirs, files in os.walk(permission_dir, topdown=False):
      for name in files:
        if(name.endswith(XML_TYPE)):
          perm_file = os.path.join(root, name)
          findPermissions(perm_file, out_dir)
  except Exception as e:
    print(str(e))
    traceback.print_exc()
    exit(1)
  print("Done")

def findPermissions(file_path, out):
  permissions = {}
  with open(file_path) as f:
    for line in f:
      if "uses-permission" in line:
        permission_name = line.split("\"")[1]
        with open(out, "a+") as output:
          print("permission name: {}".format(permission_name))
          if permission_name not in output.read():
            output.write(permission_name + "\n")

if __name__ == "__main__":
  main(sys.argv)